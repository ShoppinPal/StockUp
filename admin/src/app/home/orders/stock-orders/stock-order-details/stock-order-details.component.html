<ngx-loading [show]="loading"></ngx-loading>
<div class="animated fadeIn">
  <div class="row">
    <div class="col-sm-12">
      <div class="card">
        <div class="card-header">
          <strong>Stock order details</strong>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="form-group col-sm-6">
              <p>Name: <strong>{{order.name}}</strong></p>
              <p>Total Items: <strong>{{totalApprovedLineItems+totalNotApprovedLineItems}}</strong></p>
              <p>Created At: <strong>{{order.created | date: 'y-MM-dd HH:mm'}}</strong></p>
              <p>State: <strong>{{order.state}} <span *ngIf="order.state === reportStates.PUSHING_TO_MSD">({{order.percentagePushedToMSD || 0 | number : '1.2-2'}})%</span></strong>
                <button type="button" class="btn btn-link" (click)="getOrderDetails()">
                  <i class="fa fa-refresh"></i>
                </button>
              </p>
              <p *ngIf="order.transferOrderNumber">Transfer Order Number: <strong>{{order.transferOrderNumber}}</strong>
              </p>
            </div>
            <!--<div class="form-group col-sm-12">-->
            <!--<div class="input-group">-->
            <!--<span>(Upload Min Display Quantities and Shelf Capacities) &nbsp;&nbsp; </span>-->
            <!--<input type="file" ng2FileSelect [uploader]="uploader"/>-->
            <!--</div>-->
            <!--</div>-->
          </div>
        </div>
        <div class="card-footer">
          <div class="row">
            <div class="col-sm-3">
              <span class="input-group-btn">
                <button class="btn btn-primary" type="button" (click)="updateLineItems([], {approved: true})">Approve all</button>
              </span>
            </div>
            <div class="col-sm-3">
              <span class="input-group-btn">
                <button class="btn btn-primary" type="button" (click)="downloadOrderCSV()">Download CSV</button>
              </span>
            </div>
            <div class="col-sm-3">
              <span class="input-group-btn">

                <button class="btn btn-success" type="button"
                        (click)="createTransferOrder()"
                        *ngIf="userProfile.integrationType === 'msdynamics' && !creatingTransferOrder">Create Transfer Order</button>
                <button class="btn btn-success" type="button"
                        *ngIf="userProfile.integrationType === 'vend'"
                        (click)="createPurchaseOrderVend()">Send order to Supplier</button>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div><!--/.col-->
  </div><!--/.row-->

  <div class="row">
    <div class="col-sm-12">
      <div class="card">
        <div class="card-header">
          <strong>Search products</strong>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-12">
              <div class="form-group">
                <div class="input-group">
                  <input type="text"
                         class="form-control"
                         id="searchSKU"
                         [(ngModel)]="searchSKUText"
                         placeholder="Scan SKU barcode here or enter text">
                  <span class="input-group-btn">
                    <button class="btn btn-primary" type="button"
                            (click)="searchProductBySku(searchSKUText)">
                      <i class="fa fa-search"></i> Search
                    </button>
                  </span>
                </div>
              </div>
            </div>
          </div><!--/.row-->
        </div>
        <div class="card-footer">
          <div class="row">
            <div class="col-sm-6">
              <button type="button" class="btn btn-link"
                      (click)="searchSKUText='';getNotApprovedStockOrderLineItems();getApprovedStockOrderLineItems()">
                Clear All Searches
              </button>
            </div>
          </div>
        </div>
      </div>
    </div><!--/.col-->
  </div><!--/.row-->

  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <i class="fa fa-cubes"></i> Stock order items
          <button type="button" class="btn btn-link float-right">
            <i class="fa fa-filter fa-2x"></i>
          </button>
        </div>
        <div class="card-body">
          <tabset>
            <tab heading="Not Approved ({{totalNotApprovedLineItems}})">
              <table class="table table-striped table-hover">
                <thead>
                <tr>
                  <th>Name</th>
                  <th>SKU</th>
                  <th width="140">Order Quantity</th>
                  <th>Suggested Order Quantity</th>
                  <th>Store Inventory</th>
                  <th>Approve</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let lineItem of notApprovedLineItems">
                  <ng-container *ngIf="lineItem.productModel">
                    <td>
                      {{lineItem.productModel.name}}
                      <br/>
                      <small>({{lineItem.productModel.sizeId}} : {{lineItem.productModel.colorId}} :
                        {{lineItem.productModel.styleId}} : {{lineItem.productModel.configurationId}})
                      </small>
                    </td>
                    <td>{{lineItem.productModel.api_id}}</td>
                    <td>
                      <i class="fa fa-minus-circle quantity-icon text-danger"
                         (click)="lineItem.orderQuantity = lineItem.orderQuantity - 1"></i>
                      <input type="number" class="input-order-quantity" [(ngModel)]="lineItem.orderQuantity"/>
                      <i class="fa fa-plus-circle quantity-icon text-success"
                         (click)="lineItem.orderQuantity = lineItem.orderQuantity + 1"></i>
                    </td>
                    <td>{{lineItem.originalOrderQuantity}}</td>
                    <td>{{lineItem.storeInventory}}</td>
                    <td>
                      <button class="btn btn-danger" type="submit"
                              (click)="updateLineItems(lineItem, {approved: true, orderQuantity: lineItem.orderQuantity})">
                        <i class="fa fa-save"></i> Approve
                      </button>
                    </td>
                  </ng-container>
                </tr>
                </tbody>
              </table>
              <table class="table table-striped table-hover">
                <thead>
                <tr>
                  <th>Name</th>
                  <th>SKU</th>
                  <th width="140" *ngIf="!isWarehouser">Order Quantity</th>
                  <th *ngIf="isWarehouser">Order Quantity</th>
                  <th *ngIf="userProfile.integrationType === 'msdynamics'">Suggested Order Quantity</th>
                  <th *ngIf="userProfile.integrationType === 'msdynamics'">Store Inventory</th>
                  <th width="140" *ngIf="isWarehouser">Fulfilled Quantity</th>
                  <th>Approve</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let lineItem of notApprovedLineItems">
                  <ng-container *ngIf="lineItem.productModel">
                    <td>
                      {{lineItem.productModel.name}}
                      <br/>
                      <small>({{lineItem.productModel.sizeId}} : {{lineItem.productModel.colorId}} :
                        {{lineItem.productModel.styleId}} : {{lineItem.productModel.configurationId}})
                      </small>
                    </td>
                    <td *ngIf="userProfile.integrationType==='msdynamics'">{{lineItem.productModel.api_id}}</td>
                    <td *ngIf="userProfile.integrationType==='vend'">{{lineItem.productModel.sku}}</td>
                    <td *ngIf="!isWarehouser">
                      <i class="fa fa-minus-circle quantity-icon text-danger"
                         (click)="lineItem.orderQuantity = lineItem.orderQuantity - 1"></i>
                      <input type="number" class="input-order-quantity" [(ngModel)]="lineItem.orderQuantity"/>
                      <i class="fa fa-plus-circle quantity-icon text-success"
                         (click)="lineItem.orderQuantity = lineItem.orderQuantity + 1"></i>
                    </td>
                    <td>{{lineItem.orderQuantity}}</td>
                    <td *ngIf="userProfile.integrationType === 'msdynamics'">{{lineItem.originalOrderQuantity}}</td>
                    <td *ngIf="userProfile.integrationType === 'msdynamics'">{{lineItem.storeInventory}}</td>
                    <td *ngIf="isWarehouser">
                      <i class="fa fa-minus-circle quantity-icon text-danger"
                         (click)="lineItem.fulfilledQuantity = lineItem.fulfilledQuantity - 1"></i>
                      <input type="number" class="input-order-quantity" [(ngModel)]="lineItem.fulfilledQuantity"/>
                      <i class="fa fa-plus-circle quantity-icon text-success"
                         (click)="lineItem.fulfilledQuantity = lineItem.fulfilledQuantity + 1"></i>
                    </td>
                    <td>
                      <button class="btn btn-danger" type="submit"
                              (click)="approveItem(lineItem, selectedBox)">
                        <i class="fa fa-save"></i> Approve
                      </button>
                    </td>
                  </ng-container>
                </tr>
                </tbody>
              </table>

              <pagination [totalItems]="totalNotApprovedLineItems"
                          [(ngModel)]="currentPageNotApproved"
                          [maxSize]="maxPageDisplay"
                          [rotate]="false"
                          [boundaryLinks]="true"
                          (pageChanged)="getNotApprovedStockOrderLineItems(lineItemsLimitPerPage, ($event.page - 1) * lineItemsLimitPerPage)"
                          [itemsPerPage]="lineItemsLimitPerPage"></pagination>

            </tab>

            <tab heading="Approved ({{totalApprovedLineItems}})">
              <table class="table table-striped table-hover">
                <thead>
                <tr>
                  <th>Name</th>
                  <th>SKU</th>
                  <th *ngIf="userProfile.integrationType === 'vend'">Order Quantity</th>
                  <th *ngIf="userProfile.integrationType === 'msdynamics'">New Order Quantity</th>
                  <th *ngIf="userProfile.integrationType === 'msdynamics'">Suggested Order Quantity</th>
                  <th>Fulfilled Quantity</th>
                  <th>Approve</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let lineItem of approvedLineItems">
                  <ng-container *ngIf="lineItem.productModel">
                    <td>
                      {{lineItem.productModel.name}}
                      <br/>
                      <small>({{lineItem.productModel.sizeId}} : {{lineItem.productModel.colorId}} :
                        {{lineItem.productModel.styleId}} : {{lineItem.productModel.configurationId}})
                      </small>
                    </td>
                    <td *ngIf="userProfile.integrationType==='msdynamics'">{{lineItem.productModel.api_id}}</td>
                    <td *ngIf="userProfile.integrationType==='vend'">{{lineItem.productModel.sku}}</td>
                    <td>
                      {{lineItem.orderQuantity}}
                    </td>
                    <td *ngIf="userProfile.integrationType === 'msdynamics'">
                      {{lineItem.originalOrderQuantity}}
                    </td>
                    <td>{{lineItem.fulfilledQuantity}}</td>
                    <td>
                      <button class="btn btn-danger" type="submit"
                              (click)="removeItem(lineItem)">
                        <i class="fa fa-save"></i> Remove
                      </button>
                    </td>
                  </ng-container>
                </tr>
                </tbody>
              </table>
              <pagination [totalItems]="totalApprovedLineItems"
                          [(ngModel)]="currentPageApproved"
                          [maxSize]="maxPageDisplay"
                          [rotate]="false"
                          [boundaryLinks]="true"
                          (pageChanged)="getApprovedStockOrderLineItems(lineItemsLimitPerPage, ($event.page - 1) * lineItemsLimitPerPage)"
                          [itemsPerPage]="lineItemsLimitPerPage">
              </pagination>

            </tab>
          </tabset>
        </div>
        <div class="col-sm-2">
          <div class="selected-box">
            <div class="main-box" *ngIf="selectedBox && notApprovedLineItems && notApprovedLineItems.length">
              <div class="dropbox-qty">{{selectedBox.totalItems}}</div>
              <div *ngIf="!selectedBox.isOpen">
                <img src="./assets/img/img_closed_folder.png"
                     class="box-closed"
                     [ngClass]="{'box-disabled' : !selectedBox.isOpen}">
              </div>
              <div *ngIf="selectedBox.isOpen && selectedBox.totalItems > 0">
                <img src="./assets/img/img_open_folder.png">
              </div>
              <div *ngIf="selectedBox.isOpen && selectedBox.totalItems === 0"
                   class="box-disabled">
                <img src="./assets/img/img_open_folder.png">
              </div>
              <div class="dropbox-name">{{selectedBox.boxName}}</div>
            </div>
          </div>
          <div class="add-box" *ngIf="notApprovedLineItems && notApprovedLineItems.length">
            <button class="btn btn-primary add-btn"
                    (click)="addNewBox()" *ngIf="!(selectedBox || allProcessed)">
              Add Box
            </button>
            <button class="btn btn-primary add-btn"
                    (click)="closeBox()" *ngIf="(selectedBox || allProcessed)">
              Close Box
            </button>
          </div>
          <div class="main-box" *ngFor="let box of boxes">
            <div *ngIf="box !== selectedBox">
              <div class="dropbox-qty">{{box.totalItems}}</div>
              <div *ngIf="!box.isOpen">
                <img src="./assets/img/img_closed_folder.png"
                     class="box-closed"
                     [ngClass]="{'box-disabled' : !box.isOpen}">
              </div>
              <div *ngIf="box.isOpen && box.totalItems > 0">
                <img src="./assets/img/img_open_folder.png">
              </div>
              <div *ngIf="box.isOpen && box.totalItems === 0"
                   class="box-disabled">
                <img src="./assets/img/img_open_folder.png">
              </div>
              <div class="dropbox-name">{{box.boxName}}</div>
            </div>
          </div>

          <tab heading="Approved ({{totalApprovedLineItems}})">
            <table class="table table-striped table-hover">
              <thead>
              <tr>
                <th>Name</th>
                <th>SKU</th>
                <th>Order Quantity</th>
                <th>Suggested Order Quantity</th>
                <th>Fulfilled Quantity</th>
                <th>Approve</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let lineItem of approvedLineItems">
                <ng-container *ngIf="lineItem.productModel">
                  <td>
                    {{lineItem.productModel.name}}
                    <br/>
                    <small>({{lineItem.productModel.sizeId}} : {{lineItem.productModel.colorId}} :
                      {{lineItem.productModel.styleId}} : {{lineItem.productModel.configurationId}})
                    </small>
                  </td>
                  <td>{{lineItem.productModel.api_id}}</td>
                  <td>
                    {{lineItem.orderQuantity}}
                  </td>
                  <td>
                    {{lineItem.originalOrderQuantity}}
                  </td>
                  <td>{{lineItem.fulfilledQuantity}}</td>
                  <td>
                    <button class="btn btn-danger" type="submit"
                            (click)="updateLineItems(lineItem, {approved: false})">
                      <i class="fa fa-save"></i> Remove
                    </button>
                  </td>
                </ng-container>
              </tr>
              </tbody>
            </table>
          </tab>
        </div>

      </div>

    </div>
  </div>
</div>
<!--/.col-->
